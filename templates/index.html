<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="/static/style.css" />
  <meta charset="UTF-8" />
  <title>Recodify</title>
  <link rel="icon" type="image/svg+xml" href="/static/images/Group 2.svg" />
</head>
<body>
  <h1>
    <a href="#" onclick="resetQueryAndShowPopular(); return false;" style="color: inherit; text-decoration: none; cursor: pointer;"><img src="./static/images/Recodify.svg" alt="Recodify" class="icon"></a>
  </h1>
  <div class="floating-panel">
  <div class="search-box">
    <div class="search-input-wrapper">
      <input type="text" id="query" placeholder="曲名やアーティスト名を入力..." autocomplete="off" />
      <div id="historyList" class="history-list" style="display:none;"></div>
    </div>
    <button onclick="search()">検索</button>
  </div>
  <button onclick="showPopular()">人気の新着アルバム</button>
  <button onclick="showFavorites()">お気に入り一覧</button>
  <div id="loading" style="display: none;">
    <div class="loading-spinner"></div>
  </div>
  <div id="results" class="results"></div>
  </div>
  <div id="favorite-toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:12px 24px; border-radius:8px; font-size:16px; z-index:9999;">
    お気に入り登録しました
  </div>

  <button id="scrollTopBtn" onclick="scrollToTop()" title="トップへ戻る">▲</button>

  <script>
    // --- 検索履歴表示機能 ここから ---
    const input = document.getElementById('query');
    const historyDiv = document.getElementById('historyList');

    async function fetchHistory() {
      const res = await fetch('/search_history');
      if (!res.ok) return [];
      return await res.json();
    }

    async function showHistory() {
      const history = await fetchHistory();
      // 入力が空欄なら直近5件すべて表示
      if (!input.value.trim() && history.length > 0) {
        historyDiv.innerHTML = history
          .map(item => `<div class="history-item">${item}</div>`)
          .join('');
        historyDiv.style.display = 'block';
        return;
      }
      // 入力がある場合は部分一致で絞り込み
      if (input.value.trim() && history.length > 0) {
        const filtered = history.filter(item => item.includes(input.value));
        if (filtered.length > 0) {
          historyDiv.innerHTML = filtered
            .map(item => `<div class="history-item">${item}</div>`)
            .join('');
          historyDiv.style.display = 'block';
        } else {
          historyDiv.style.display = 'none';
          historyDiv.innerHTML = '';
        }
        return;
      }
      // 履歴がなければ非表示
      historyDiv.style.display = 'none';
      historyDiv.innerHTML = '';
    }

    historyDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('history-item')) {
        input.value = e.target.textContent;
        historyDiv.style.display = 'none';
        input.focus();
      }
    });

    input.addEventListener('input', showHistory);
    input.addEventListener('focus', showHistory);

    document.addEventListener('click', function(e) {
      if (!input.contains(e.target) && !historyDiv.contains(e.target)) {
        historyDiv.style.display = 'none';
      }
    });

    // 検索時に履歴保存
    async function saveHistory(query) {
      if (!query.trim()) return;
      await fetch('/search_history', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({query})
      });
    }
    // --- 検索履歴表示機能 ここまで ---

    function showLoading() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    window.onload = () => {
      showPopular();
    };

    async function search(artistName) {
      const query = artistName || document.getElementById('query').value;
      if (!query) return;

      document.getElementById('query').value = query;
      await saveHistory(query); // 履歴保存
      
      showLoading();
      try {
        const res = await fetch(`/search?q=${encodeURIComponent(query)}`); //ここで検索した内容をapp.pyに送る
        const tracks = await res.json();
        hideLoading();
        
        const container = document.getElementById('results');
        container.innerHTML = "";

        if (tracks.error) {
          container.innerHTML = `<p style="color:red;">${tracks.error}</p>`;
          return;
        }

        let htmlContent = "";
        tracks.forEach((t, index) => {
          const html = `
            <div class="track" style="animation-delay: ${index * 0.001}s">
              ${t.image ? `<img src="${t.image}" alt="${t.name}">` : ""}
              <h3>${t.name}</h3>
              <p class="goartist" onclick='search(${JSON.stringify(t.artist)})'>${t.artist}</p>
              <button class="favorite-btn" onclick='addFavorite(this, ${JSON.stringify(t)})'>♡</button>
              <a href="/player?track_id=${t.id}" class="button-link">▶</a>
            </div>
          `;
          htmlContent += html;
        });
        container.innerHTML = htmlContent;
      } catch (e) {
        hideLoading();
        console.error(e);
        document.getElementById('results').innerHTML = '<p>エラーが発生しました</p>';
      }
    }
    
    async function showPopular() {
      showLoading();
      try {
        const res = await fetch('/popular');
        const albums = await res.json();
        hideLoading();

        const container = document.getElementById('results');
        container.innerHTML = "";

        if (albums.error) {
          container.innerHTML = `<p style="color:red;">${albums.error}</p>`;
          return;
        }

        let htmlContent = "";
        albums.forEach((t, index) => {
          const html = `
            <div class="track" style="animation-delay: ${index * 0.001}s">
              ${t.image ? `<img src="${t.image}" alt="${t.name}">` : ""}
              <h3>${t.name}</h3>
              <p class="goartist" onclick='search(${JSON.stringify(t.artist)})'>${t.artist}</p>
              <button class="favorite-btn" onclick='addFavorite(this, ${JSON.stringify(t)})'>♡</button>
              <a href="/player?track_id=${t.track_id}" class="button-link">▶</a>
            </div>
          `;
          htmlContent += html;
        });
        container.innerHTML = htmlContent;
      } catch (e) {
        hideLoading();
        console.error(e);
        document.getElementById('results').innerHTML = '<p>エラーが発生しました</p>';
      }
    }

    async function showFavorites() {
      showLoading();
      try {
        const tracks = await fetchFavorites();
        hideLoading();

        const container = document.getElementById('results');
        container.innerHTML = "";

        if (!tracks || tracks.length === 0) {
          container.innerHTML = "<p>お気に入りはまだありません。</p>";
          return;
        }

        let htmlContent = "";
        tracks.forEach((t, index) => {
          const html = `
            <div class="track" style="animation-delay: ${index * 0.001}s">
              ${t.image ? `<img src="${t.image}" alt="${t.name}">` : ""}
              <h3>${t.name}</h3>
              <p class="goartist" onclick='search(${JSON.stringify(t.artist)})'>${t.artist}</p>
              <button onclick="removeFavorite('${t.track_id}').then(() => showFavorites())">削除</button>
              <a href="/player?track_id=${t.track_id}" class="button-link">▶</a>
            </div>
          `;
          htmlContent += html;
        });
        container.innerHTML = htmlContent;
      } catch (e) {
        hideLoading();
        console.error(e);
        document.getElementById('results').innerHTML = '<p>エラーが発生しました</p>';
      }
    }

    // お気に入り登録時のトースト表示
    function showFavoriteToast() {
      const toast = document.getElementById('favorite-toast');
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // ハート→チェックマーク変化＆お気に入り登録
    async function addFavorite(btn, track) {
      try {
        const res = await fetch('/favorites', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(track)
        });
        await res.json();
        // チェックマークに変更し、背景色はそのまま
        btn.innerHTML = '<span style="color:#fff;font-size:22px;">✔</span>';
        btn.disabled = true;
        showFavoriteToast();
      } catch (e) {
        console.error('failed to add favorite', e);
        alert('お気に入り登録に失敗しました');
      }
    }

    async function removeFavorite(track_id) {
      try {
        const res = await fetch(`/favorites/${encodeURIComponent(track_id)}`, { method: 'DELETE' });
        return res.status === 204;
      } catch (e) {
        console.error('failed to remove favorite', e);
        throw e;
      }
    }

    async function fetchFavorites() {
      try {
        const res = await fetch('/favorites');
        return await res.json();
      } catch (e) {
        console.error('failed to fetch favorites', e);
        return [];
      }
    }

    // Spotify 検索クリック時に検索欄をリセットして人気新着アルバムを表示し、履歴も非表示にする
    function resetQueryAndShowPopular() {
      input.value = '';
      historyDiv.style.display = 'none';
      historyDiv.innerHTML = '';
      showPopular();
    }

    // --- トップへ戻るボタン機能 ---
    const scrollTopBtn = document.getElementById("scrollTopBtn");

    window.onscroll = function() {
      scrollFunction();
    };

    function scrollFunction() {
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        scrollTopBtn.style.display = "block";
      } else {
        scrollTopBtn.style.display = "none";
      }
    }

    function scrollToTop() {
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
  </script>
</body>
</html>
